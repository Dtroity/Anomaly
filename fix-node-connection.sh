#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –Ω–æ–¥–µ Marzban

PROJECT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$PROJECT_DIR"

echo "üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –Ω–æ–¥–µ Marzban"
echo "==========================================="
echo ""

# 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –∑–∞–ø—É—â–µ–Ω –ª–∏ Marzban
if ! docker-compose ps marzban | grep -q "Up"; then
    echo "‚ùå Marzban –Ω–µ –∑–∞–ø—É—â–µ–Ω. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –µ–≥–æ —Å–Ω–∞—á–∞–ª–∞:"
    echo "   docker-compose up -d marzban"
    exit 1
fi

echo "‚úÖ Marzban –∑–∞–ø—É—â–µ–Ω"
echo ""

# 2. –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–æ–¥–µ
echo "üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–æ–¥–µ –∏–∑ –ø–∞–Ω–µ–ª–∏:"
echo "   –ê–¥—Ä–µ—Å: 185.126.67.67"
echo "   –ü–æ—Ä—Ç: 62050"
echo "   API –ø–æ—Ä—Ç: 62051"
echo ""

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –Ω–æ–¥—ã
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –Ω–æ–¥—ã..."
NODE_IP="185.126.67.67"
NODE_PORT="62050"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ ping
if ping -c 1 -W 2 "$NODE_IP" > /dev/null 2>&1; then
    echo "  ‚úÖ IP –∞–¥—Ä–µ—Å –¥–æ—Å—Ç—É–ø–µ–Ω (ping)"
else
    echo "  ‚ö†Ô∏è  IP –∞–¥—Ä–µ—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (ping)"
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–∞
if timeout 3 bash -c "echo > /dev/tcp/$NODE_IP/$NODE_PORT" 2>/dev/null; then
    echo "  ‚úÖ –ü–æ—Ä—Ç $NODE_PORT –¥–æ—Å—Ç—É–ø–µ–Ω"
else
    echo "  ‚ùå –ü–æ—Ä—Ç $NODE_PORT –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
    echo "     –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:"
    echo "     1. –ó–∞–ø—É—â–µ–Ω –ª–∏ marzban-node –Ω–∞ –Ω–æ–¥–µ"
    echo "     2. –û—Ç–∫—Ä—ã—Ç –ª–∏ –ø–æ—Ä—Ç $NODE_PORT –≤ —Ñ–∞–π—Ä–≤–æ–ª–µ"
    echo "     3. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ª–∏ IP –∞–¥—Ä–µ—Å"
fi
echo ""

# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å DNS —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ DNS —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è..."
if getent hosts "$NODE_IP" > /dev/null 2>&1; then
    echo "  ‚úÖ DNS —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
else
    echo "  ‚ö†Ô∏è  –ü—Ä–æ–±–ª–µ–º–∞ —Å DNS —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ–º"
fi
echo ""

# 5. –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –Ω–æ–¥—ã
echo "üìù –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –Ω–æ–¥—ã:"
echo ""
echo "1. –ù–∞ Control Server (–≥–¥–µ –∑–∞–ø—É—â–µ–Ω Marzban):"
echo "   - –û—Ç–∫—Ä–æ–π—Ç–µ –ø–∞–Ω–µ–ª—å: https://panel.anomaly-connect.online"
echo "   - –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª 'Marzban-Node'"
echo "   - –ù–∞–∂–º–∏—Ç–µ '–°–∫–∞—á–∞—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç' –¥–ª—è Node 1"
echo "   - –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç"
echo ""
echo "2. –ù–∞ Node Server (185.126.67.67):"
echo "   - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ marzban-node (–µ—Å–ª–∏ –µ—â–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)"
echo "   - –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–∫–∞—á–∞–Ω–Ω—ã–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –Ω–∞ –Ω–æ–¥—É"
echo "   - –ù–∞—Å—Ç—Ä–æ–π—Ç–µ .env.node —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:"
echo "     CONTROL_SERVER_URL=https://panel.anomaly-connect.online"
echo "     SSL_CLIENT_CERT_FILE=/path/to/certificate.pem"
echo "   - –ó–∞–ø—É—Å—Ç–∏—Ç–µ marzban-node"
echo ""
echo "3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ:"
echo "   - –í–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ –ø–∞–Ω–µ–ª—å Marzban"
echo "   - –ù–∞–∂–º–∏—Ç–µ '–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è' –¥–ª—è Node 1"
echo "   - –°—Ç–∞—Ç—É—Å –¥–æ–ª–∂–µ–Ω –∏–∑–º–µ–Ω–∏—Ç—å—Å—è –Ω–∞ '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ'"
echo ""

# 6. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –Ω–æ–¥—ã –≤ Marzban
echo "üìä –¢–µ–∫—É—â–∏–µ –Ω–æ–¥—ã –≤ Marzban:"
docker-compose exec -T marzban marzban-cli node list 2>/dev/null || echo "  ‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –Ω–æ–¥"
echo ""

echo "‚úÖ –ì–æ—Ç–æ–≤–æ!"
echo ""
echo "üí° –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ '[Errno -2] Name or service not known' —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è:"
echo "   1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –Ω–∞ –Ω–æ–¥–µ –∑–∞–ø—É—â–µ–Ω marzban-node"
echo "   2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø–æ—Ä—Ç 62050 –æ—Ç–∫—Ä—ã—Ç –≤ —Ñ–∞–π—Ä–≤–æ–ª–µ –Ω–∞ –Ω–æ–¥–µ"
echo "   3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ –Ω–æ–¥–µ"
echo "   4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ marzban-node –Ω–∞ –Ω–æ–¥–µ"
echo ""
