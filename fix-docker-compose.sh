#!/bin/bash

# ะกะบัะธะฟั ะดะปั ะธัะฟัะฐะฒะปะตะฝะธั ะฟัะพะฑะปะตะผั ั docker-compose ะธ ะฟะตัะตัะพะทะดะฐะฝะธั ะบะพะฝัะตะนะฝะตัะพะฒ

set -e

echo "๐ง ะัะฟัะฐะฒะปะตะฝะธะต ะฟัะพะฑะปะตะผั ั docker-compose..."
echo ""

# 1. ะััะฐะฝะพะฒะธัั ะฒัะต ะบะพะฝัะตะนะฝะตัั
echo "โธ๏ธ  ะััะฐะฝะพะฒะบะฐ ะฒัะตั ะบะพะฝัะตะนะฝะตัะพะฒ..."
docker-compose down

# 2. ะฃะดะฐะปะธัั ะฒัะต ะบะพะฝัะตะนะฝะตัั ั ะฝะตะฟัะฐะฒะธะปัะฝัะผะธ ะธะผะตะฝะฐะผะธ
echo "๐งน ะฃะดะฐะปะตะฝะธะต ััะฐััั ะบะพะฝัะตะนะฝะตัะพะฒ..."
docker ps -a | grep anomaly | awk '{print $1}' | xargs -r docker rm -f 2>/dev/null || true

# 3. ะฃะดะฐะปะธัั ััะฐััะต ะพะฑัะฐะทั (ะพะฟัะธะพะฝะฐะปัะฝะพ, ะตัะปะธ ะฝัะถะฝะพ)
# docker images | grep anomaly | awk '{print $3}' | xargs -r docker rmi -f 2>/dev/null || true

# 4. ะะฐะฟัััะธัั ัะตัะฒะธัั ะฒ ะฟัะฐะฒะธะปัะฝะพะผ ะฟะพััะดะบะต
echo "๐ ะะฐะฟััะบ ัะตัะฒะธัะพะฒ ะฒ ะฟัะฐะฒะธะปัะฝะพะผ ะฟะพััะดะบะต..."

# ะะฐะทะฐ ะดะฐะฝะฝัั
echo "๐ฆ ะะฐะฟััะบ ะฑะฐะทั ะดะฐะฝะฝัั..."
docker-compose up -d db
echo "โณ ะะถะธะดะฐะฝะธะต ะณะพัะพะฒะฝะพััะธ ะฑะฐะทั ะดะฐะฝะฝัั..."
sleep 10

# Marzban
echo "๐ฆ ะะฐะฟััะบ Marzban..."
docker-compose up -d marzban
echo "โณ ะะถะธะดะฐะฝะธะต ะทะฐะฟััะบะฐ Marzban..."
sleep 10

# API ะธ Bot
echo "๐ฆ ะะฐะฟััะบ API ะธ Bot..."
docker-compose up -d api bot
echo "โณ ะะถะธะดะฐะฝะธะต ะทะฐะฟััะบะฐ API ะธ Bot..."
sleep 10

# Nginx
echo "๐ฆ ะะฐะฟััะบ Nginx..."
docker-compose up -d nginx
echo "โณ ะะถะธะดะฐะฝะธะต ะทะฐะฟััะบะฐ Nginx..."
sleep 5

# 5. ะัะพะฒะตัะธัั ััะฐััั
echo ""
echo "๐ ะกัะฐััั ะฒัะตั ัะตัะฒะธัะพะฒ:"
docker-compose ps

# 6. ะัะพะฒะตัะธัั ะปะพะณะธ
echo ""
echo "๐ ะะพะณะธ Nginx (ะฟะพัะปะตะดะฝะธะต 20 ัััะพะบ):"
docker-compose logs --tail=20 nginx

echo ""
echo "๐ ะะพะณะธ API (ะฟะพัะปะตะดะฝะธะต 10 ัััะพะบ):"
docker-compose logs --tail=10 api

# 7. ะัะพะฒะตัะธัั ะดะพัััะฟะฝะพััั
echo ""
echo "๐ ะัะพะฒะตัะบะฐ ะดะพัััะฟะฝะพััะธ:"
echo -n "ะะพะบะฐะปัะฝัะน API: "
curl -s http://localhost/health 2>/dev/null && echo "โ" || echo "โ"

echo -n "ะะฝะตัะฝะธะน API: "
curl -s http://api.anomaly-connect.online/health 2>/dev/null && echo "โ" || echo "โ"

echo ""
echo "โ ะะพัะพะฒะพ!"

