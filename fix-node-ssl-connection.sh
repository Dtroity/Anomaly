#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è SSL/TLS —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –Ω–æ–¥–æ–π

PROJECT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$PROJECT_DIR"

echo "üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ SSL/TLS —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –Ω–æ–¥–æ–π"
echo "=========================================="
echo ""

NODE_IP="185.126.67.67"
NODE_PORT="62050"

# 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –Ω–æ–¥–µ
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –Ω–æ–¥–µ:"
echo ""

echo "  –¢–µ—Å—Ç 1: HTTP –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ (–±–µ–∑ SSL)..."
HTTP_RESPONSE=$(timeout 5 curl -s -o /dev/null -w "%{http_code}" "http://${NODE_IP}:${NODE_PORT}/ping" 2>/dev/null || echo "000")
if [ "$HTTP_RESPONSE" != "000" ] && [ "$HTTP_RESPONSE" != "" ]; then
    echo "    ‚úÖ HTTP –¥–æ—Å—Ç—É–ø–µ–Ω (–∫–æ–¥: $HTTP_RESPONSE)"
else
    echo "    ‚ùå HTTP –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
fi

echo ""
echo "  –¢–µ—Å—Ç 2: HTTPS –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ (—Å SSL, –∏–≥–Ω–æ—Ä–∏—Ä—É—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç)..."
HTTPS_RESPONSE=$(timeout 5 curl -k -s -o /dev/null -w "%{http_code}" "https://${NODE_IP}:${NODE_PORT}/ping" 2>/dev/null || echo "000")
if [ "$HTTPS_RESPONSE" != "000" ] && [ "$HTTPS_RESPONSE" != "" ]; then
    echo "    ‚úÖ HTTPS –¥–æ—Å—Ç—É–ø–µ–Ω (–∫–æ–¥: $HTTPS_RESPONSE)"
else
    echo "    ‚ùå HTTPS –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
fi

echo ""
echo "  –¢–µ—Å—Ç 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞..."
SSL_INFO=$(timeout 5 openssl s_client -connect "${NODE_IP}:${NODE_PORT}" -servername "${NODE_IP}" </dev/null 2>/dev/null | grep -E "subject=|issuer=|Verify return code" || echo "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–µ")
if [ -n "$SSL_INFO" ]; then
    echo "    üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–µ:"
    echo "$SSL_INFO" | sed 's/^/      /'
else
    echo "    ‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–µ"
fi

echo ""

# 2. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
echo "üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:"
echo ""
echo "1. –ù–∞ –Ω–æ–¥–µ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç:"
echo "   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ"
echo "   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—É—Ç—å –∫ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—É –≤ .env.node:"
echo "     SSL_CLIENT_CERT_FILE=/path/to/certificate.pem"
echo ""
echo "2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ marzban-node –Ω–∞ –Ω–æ–¥–µ:"
echo "   docker logs anomaly-node --tail=50 | grep -i 'ssl\|certificate\|error'"
echo ""
echo "3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ marzban-node –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç:"
echo "   - –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–∫–∞—á–∞–Ω –∏–∑ –ø–∞–Ω–µ–ª–∏ Marzban"
echo "   - –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ –Ω–æ–¥–µ"
echo "   - –ü—É—Ç—å –∫ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—É –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–∫–∞–∑–∞–Ω –≤ .env.node"
echo ""
echo "4. –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ:"
echo "   - –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –Ω–æ–¥—É –≤ –ø–∞–Ω–µ–ª–∏"
echo "   - –°–∫–∞—á–∞—Ç—å –Ω–æ–≤—ã–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç"
echo "   - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –Ω–∞ –Ω–æ–¥–µ –∑–∞–Ω–æ–≤–æ"
echo ""

echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo ""

