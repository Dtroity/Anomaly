#!/bin/bash
# –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã —Å Xray core –Ω–∞ –Ω–æ–¥–µ

echo "üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã —Å Xray core –Ω–∞ –Ω–æ–¥–µ"
echo "============================================="
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞, –Ω–∞ –∫–∞–∫–æ–º —Å–µ—Ä–≤–µ—Ä–µ –∑–∞–ø—É—â–µ–Ω —Å–∫—Ä–∏–ø—Ç
if [ ! -f docker-compose.node.yml ]; then
    echo "‚ö†Ô∏è  –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω –Ω–∞ Node Server (VPS #2)"
    exit 1
fi

echo "‚úÖ –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –Ω–æ–¥–∞"
echo ""

echo "1Ô∏è‚É£  –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–∞ 443 (VMess TCP)..."
if netstat -tuln 2>/dev/null | grep -q ":443 "; then
    echo "   ‚ö†Ô∏è  –ü–æ—Ä—Ç 443 –∑–∞–Ω—è—Ç:"
    netstat -tuln 2>/dev/null | grep ":443 " | sed 's/^/      /'
    echo "   üí° –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–∏—á–∏–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ Xray core"
else
    echo "   ‚úÖ –ü–æ—Ä—Ç 443 —Å–≤–æ–±–æ–¥–µ–Ω"
fi

echo ""
echo "2Ô∏è‚É£  –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –ø–æ—Ä—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–æ–¥–∞..."
PORTS_TO_CHECK=(443 80 62050 62051)
for port in "${PORTS_TO_CHECK[@]}"; do
    if netstat -tuln 2>/dev/null | grep -q ":$port "; then
        echo "   ‚ö†Ô∏è  –ü–æ—Ä—Ç $port –∑–∞–Ω—è—Ç:"
        netstat -tuln 2>/dev/null | grep ":$port " | sed 's/^/      /'
    else
        echo "   ‚úÖ –ü–æ—Ä—Ç $port —Å–≤–æ–±–æ–¥–µ–Ω"
    fi
done

echo ""
echo "3Ô∏è‚É£  –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–µ—Ç–∞–ª—å–Ω—ã—Ö –ª–æ–≥–æ–≤ Xray core..."
echo "   üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ 500 —Å—Ç—Ä–æ–∫ –ª–æ–≥–æ–≤ (–ø–æ–∏—Å–∫ –æ—à–∏–±–æ–∫ Xray):"
docker logs anomaly-node --tail 500 2>&1 | grep -i -E "(xray|core|start|stop|fail|error|invalid|exception|panic)" | tail -50 | sed 's/^/      /'

echo ""
echo "4Ô∏è‚É£  –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Control Server..."
echo "   üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:"
docker logs anomaly-node --tail 100 2>&1 | grep -E "(connected|disconnected|POST /connect|POST /start|POST /restart)" | tail -10 | sed 's/^/      /'

echo ""
echo "5Ô∏è‚É£  –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä—É—é –ø–æ–ª—É—á–∞–µ—Ç –Ω–æ–¥–∞..."
echo "   üí° –ù–æ–¥–∞ –ø–æ–ª—É—á–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Xray –æ—Ç Control Server –ø—Ä–∏ –≤—ã–∑–æ–≤–µ /start –∏–ª–∏ /restart"
echo "   üìã –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ /start –∏–ª–∏ /restart:"
docker logs anomaly-node --tail 200 2>&1 | grep -E "(POST /start|POST /restart)" | tail -5 | sed 's/^/      /'

echo ""
echo "6Ô∏è‚É£  –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:"
echo "   üí° –ï—Å–ª–∏ Xray core –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è:"
echo "      1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–æ—Ä—Ç 443 –Ω–µ –∑–∞–Ω—è—Ç –¥—Ä—É–≥–∏–º–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏"
echo "      2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Xray –≤ –ø–∞–Ω–µ–ª–∏ Marzban –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫"
echo "      3. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ—Ä—Ç VMess TCP —Å 443 –Ω–∞ –¥—Ä—É–≥–æ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, 8443)"
echo "      4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –Ω–∞ –Ω–æ–¥–µ –Ω–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ (nginx, apache –∏ —Ç.–¥.)"
echo "      5. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–æ–¥—É:"
echo "         docker-compose -f docker-compose.node.yml restart marzban-node"
echo ""

