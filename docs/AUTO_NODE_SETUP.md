# Автоматическая настройка ноды

Эта система позволяет автоматически настроить ноду Marzban через SSH, без ручной настройки.

## Компоненты

1. **`node-auto-setup.sh`** - Скрипт установки на ноде (VPS #2)
2. **`auto-setup-node.sh`** - Скрипт автоматической настройки на Control Server (VPS #1)

## Использование

### На Control Server (VPS #1)

```bash
cd /opt/Anomaly
git pull
chmod +x auto-setup-node.sh

# Автоматическая настройка ноды
./auto-setup-node.sh <NODE_IP> <NODE_USER> <NODE_PASSWORD> [NODE_NAME] [NODE_PORT] [API_PORT] [CONTROL_SERVER_URL]
```

**Пример:**
```bash
./auto-setup-node.sh 185.126.67.67 root MyPassword123 "Node 1" 62050 62051 https://panel.anomaly-connect.online
```

### Что делает скрипт

1. **Получает сертификат** из базы данных Marzban
2. **Подключается к ноде** через SSH
3. **Устанавливает зависимости** (Docker, Docker Compose)
4. **Клонирует репозиторий** Anomaly
5. **Устанавливает сертификат** на ноду
6. **Настраивает .env.node**
7. **Генерирует серверный сертификат** (если не существует)
8. **Запускает Marzban Node**
9. **Синхронизирует сертификат и ключ** с ноды в базу данных
10. **Создает ноду в Marzban** через API

## Требования

### На Control Server:
- SSH доступ к ноде
- `sshpass` (опционально, для автоматической передачи пароля):
  ```bash
  apt-get install sshpass
  ```
- Или настроенные SSH ключи

### На ноде:
- Доступ root
- Интернет соединение
- Порты 62050, 62051, 443, 80 открыты

## Интеграция с панелью Marzban

Для автоматической настройки при создании ноды в панели, можно:

1. **Использовать API endpoint** (если создан):
   ```bash
   curl -X POST https://api.anomaly-connect.online/api/auto-setup/node \
     -H "Content-Type: application/json" \
     -d '{
       "node_ip": "185.126.67.67",
       "node_user": "root",
       "node_password": "MyPassword123",
       "node_name": "Node 1",
       "node_port": 62050,
       "api_port": 62051
     }'
   ```

2. **Или вызвать скрипт вручную** после создания ноды в панели

## Устранение неполадок

### Ошибка подключения SSH
- Проверьте, что SSH доступен на ноде
- Убедитесь, что пароль правильный
- Проверьте, что порт SSH открыт

### Ошибка установки Docker
- Проверьте интернет соединение на ноде
- Убедитесь, что у пользователя есть права root

### Ошибка синхронизации сертификата
- Проверьте, что сертификат установлен на ноде
- Убедитесь, что ключ существует на ноде

## Безопасность

⚠️ **ВАЖНО:** Пароль передается через командную строку, что может быть видно в процессах.

**Рекомендации:**
1. Используйте SSH ключи вместо паролей
2. Ограничьте доступ к скрипту
3. Используйте временные пароли
4. После настройки измените пароль root на ноде

