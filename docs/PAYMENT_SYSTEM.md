# üí≥ –ü–ª–∞—Ç–µ–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ Anomaly Connect

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

–ü–ª–∞—Ç–µ–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞ –Ω–∞ **–∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤**, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —Å–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ–¥–∞.

```
Bot/API
   ‚Üì
PaymentService (–∞–±—Å—Ç—Ä–∞–∫—Ü–∏—è)
   ‚Üì
PaymentProvider (–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å)
   ‚îú‚îÄ‚îÄ YooKassaProvider
   ‚îú‚îÄ‚îÄ TelegramPayProvider
   ‚îú‚îÄ‚îÄ CryptoProvider
   ‚îî‚îÄ‚îÄ [–Ω–æ–≤—ã–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã]
```

## üìã –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã

### 1. –ÆKassa (–æ—Å–Ω–æ–≤–Ω–æ–π)

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞:**
```env
YOOKASSA_SHOP_ID=your_shop_id
YOOKASSA_SECRET_KEY=your_secret_key
YOOKASSA_TEST_MODE=false
```

**Webhook:** `https://api.anomaly-connect.online/webhook/payment/yookassa`

### 2. Telegram Payments

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞:**
```env
TELEGRAM_PAYMENT_PROVIDER_TOKEN=your_provider_token
```

**–û–±—Ä–∞–±–æ—Ç–∫–∞:** —á–µ—Ä–µ–∑ –±–æ—Ç–∞ (inline invoice)

### 3. –ö—Ä–∏–ø—Ç–æ–ø–ª–∞—Ç–µ–∂–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞:**
```env
CRYPTO_WALLET_ADDRESS=your_wallet_address
CRYPTO_NETWORK=TRC20
```

**Webhook:** `https://api.anomaly-connect.online/webhook/payment/crypto`

## üîß –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞

### –®–∞–≥ 1: –°–æ–∑–¥–∞—Ç—å –∫–ª–∞—Å—Å –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞

```python
from services.payment_provider import PaymentProvider, PaymentStatus

class NewProvider(PaymentProvider):
    def __init__(self, api_key: str):
        self.api_key = api_key
    
    def create_payment(self, amount, currency, description, user_id, metadata=None):
        # –õ–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞
        return {
            "provider": "new_provider",
            "payment_id": "...",
            "status": PaymentStatus.PENDING.value,
            "confirmation_url": "..."
        }
    
    def get_payment_status(self, payment_id: str) -> PaymentStatus:
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
        return PaymentStatus.SUCCESS
    
    def verify_webhook(self, data: Dict, signature: Optional[str] = None) -> bool:
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ webhook
        return True
    
    def process_webhook(self, data: Dict) -> Dict:
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ webhook
        return {"payment_id": "...", "status": "success"}
```

### –®–∞–≥ 2: –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ PaymentService

```python
# –í services/payment_provider.py
def _init_providers(self):
    # ...
    if settings.new_provider_api_key:
        self.providers["new_provider"] = NewProvider(
            api_key=settings.new_provider_api_key
        )
```

### –®–∞–≥ 3: –î–æ–±–∞–≤–∏—Ç—å –≤ enum

```python
# –í models.py
class PaymentMethod(str, enum.Enum):
    # ...
    NEW_PROVIDER = "new_provider"
```

## üìä –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π

–í—Å–µ –ø–ª–∞—Ç–µ–∂–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è:

1. **–í –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö** (`system_logs` —Ç–∞–±–ª–∏—Ü–∞)
2. **–í —Ñ–∞–π–ª—ã** (`vpnbot/logs/`)
3. **–ú–µ—Ç—Ä–∏–∫–∏** –¥–æ—Å—Ç—É–ø–Ω—ã —á–µ—Ä–µ–∑ `/admin` –∏ `/stats`

### –¢–∏–ø—ã –ª–æ–≥–æ–≤:

- `payment.created` - —Å–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
- `payment.completed` - —É—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞
- `payment.failed` - –Ω–µ—É–¥–∞—á–Ω–∞—è –æ–ø–ª–∞—Ç–∞
- `payment.refunded` - –≤–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤

## üîÑ –ü–æ—Ç–æ–∫ –ø–ª–∞—Ç–µ–∂–∞

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç —Ç–∞—Ä–∏—Ñ
   ‚Üì
2. Bot/API —Å–æ–∑–¥–∞–µ—Ç –ø–ª–∞—Ç–µ–∂ —á–µ—Ä–µ–∑ PaymentService
   ‚Üì
3. PaymentService –≤—ã–±–∏—Ä–∞–µ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
   ‚Üì
4. –ü—Ä–æ–≤–∞–π–¥–µ—Ä —Å–æ–∑–¥–∞–µ—Ç –ø–ª–∞—Ç–µ–∂
   ‚Üì
5. –ü–ª–∞—Ç–µ–∂ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î (—Å—Ç–∞—Ç—É—Å: PENDING)
   ‚Üì
6. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç
   ‚Üì
7. Webhook –æ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
   ‚Üì
8. PaymentService –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç webhook
   ‚Üì
9. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –≤ –ë–î (SUCCESS)
   ‚Üì
10. –ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   ‚Üì
11. –°–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ Marzban
   ‚Üì
12. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
```

## üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### Webhook –≤–∞–ª–∏–¥–∞—Ü–∏—è

–ö–∞–∂–¥—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä –¥–æ–ª–∂–µ–Ω —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `verify_webhook()`:

- **–ÆKassa**: –ø—Ä–æ–≤–µ—Ä–∫–∞ IP whitelist –∏ –ø–æ–¥–ø–∏—Å–∏
- **Telegram**: –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ Telegram API
- **Crypto**: –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ –±–ª–æ–∫—á–µ–π–Ω–µ

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í—Å–µ –ø–ª–∞—Ç–µ–∂–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å:
- User ID
- Amount
- Provider
- Status
- Timestamp
- Metadata (JSON)

## üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞

### –î–æ—Å—Ç—É–ø–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏:

- –î–æ—Ö–æ–¥ –ø–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º
- –ö–æ–Ω–≤–µ—Ä—Å–∏—è –ø–ª–∞—Ç–µ–∂–µ–π
- –°—Ä–µ–¥–Ω–∏–π —á–µ–∫
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ø–µ—à–Ω—ã—Ö/–Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π
- –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–∞

### –ö–æ–º–∞–Ω–¥—ã:

- `/stats` - –æ–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- `/admin` - –¥–µ—Ç–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### –í–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞

1. –î–æ–±–∞–≤—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ `.env`
2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–∏—Å—ã: `docker-compose restart bot api`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å: `/api/payment/providers`

### –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞

–ü—Ä–æ—Å—Ç–æ —É–¥–∞–ª–∏—Ç–µ –∏–ª–∏ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ `.env`

---

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏:**
- ‚úÖ –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã
- ‚úÖ –ï–¥–∏–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –≤—Å–µ—Ö –ø–ª–∞—Ç–µ–∂–µ–π
- ‚úÖ –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ –ü—Ä–æ—Å—Ç–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

